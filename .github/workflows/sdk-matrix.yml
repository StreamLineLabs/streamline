name: SDK Compatibility Matrix

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly, Monday 6 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-matrix:
    name: Generate SDK Compatibility Matrix
    runs-on: ubuntu-latest
    steps:
      - name: Checkout all repos
        uses: actions/checkout@v4
        with:
          path: streamline

      - name: Checkout SDKs
        run: |
          for sdk in streamline-java-sdk streamline-python-sdk streamline-go-sdk streamline-node-sdk streamline-rust-sdk streamline-dotnet-sdk streamline-wasm-sdk; do
            git clone --depth 1 https://github.com/streamlinelabs/$sdk.git || echo "Skipping $sdk"
          done

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Generate matrix
        run: |
          cd streamline
          python3 scripts/generate-sdk-matrix.py -o docs/SDK_COMPATIBILITY_MATRIX.md

      - name: Check for changes
        id: changes
        run: |
          cd streamline
          if git diff --quiet docs/SDK_COMPATIBILITY_MATRIX.md 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create PR if changed
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          path: streamline
          commit-message: 'docs: update SDK compatibility matrix'
          title: 'docs: update SDK compatibility matrix'
          body: |
            Auto-generated update to the SDK compatibility matrix.

            This PR was created automatically by the SDK Compatibility Matrix workflow.
          branch: docs/update-sdk-matrix
          delete-branch: true
