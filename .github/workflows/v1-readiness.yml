name: v1.0 Readiness Tracker

on:
  push:
    tags: ['v0.*', 'v1.0.0-rc*']
  schedule:
    - cron: '0 6 * * 1'  # Mondays 6am UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  readiness-check:
    name: v1.0 Readiness Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run readiness checker
        id: check
        run: |
          chmod +x scripts/check-v1-readiness.sh
          scripts/check-v1-readiness.sh --verbose 2>&1 | tee readiness-report.txt || true

          # Parse results
          PASS=$(grep -c 'âœ…' readiness-report.txt || echo 0)
          FAIL=$(grep -c 'âŒ' readiness-report.txt || echo 0)
          WARN=$(grep -c 'âš ï¸' readiness-report.txt || echo 0)

          echo "pass=$PASS" >> $GITHUB_OUTPUT
          echo "fail=$FAIL" >> $GITHUB_OUTPUT
          echo "warn=$WARN" >> $GITHUB_OUTPUT

          TOTAL=$((PASS + FAIL + WARN))
          PCT=$((PASS * 100 / (TOTAL > 0 ? TOTAL : 1)))
          echo "pct=$PCT" >> $GITHUB_OUTPUT

      - name: Generate summary
        run: |
          echo "## v1.0 Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Score: ${{ steps.check.outputs.pass }} / $(( ${{ steps.check.outputs.pass }} + ${{ steps.check.outputs.fail }} + ${{ steps.check.outputs.warn }} )) (${{ steps.check.outputs.pct }}%)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | ${{ steps.check.outputs.pass }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | ${{ steps.check.outputs.fail }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ Warnings | ${{ steps.check.outputs.warn }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.fail }}" = "0" ]; then
            echo "### âœ… READY FOR v1.0" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ NOT READY (${{ steps.check.outputs.fail }} failures)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Full Report</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat readiness-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: v1-readiness-${{ github.sha }}
          path: readiness-report.txt
          retention-days: 90

      - name: Track consecutive clean releases
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          FAIL=${{ steps.check.outputs.fail }}

          mkdir -p .v1-tracking
          if [ "$FAIL" -eq 0 ]; then
            echo "$TAG: PASS ($(date -u +%Y-%m-%dT%H:%M:%SZ))" >> .v1-tracking/release-history.txt
          else
            echo "$TAG: FAIL ($FAIL failures) ($(date -u +%Y-%m-%dT%H:%M:%SZ))" >> .v1-tracking/release-history.txt
          fi

          # Count consecutive passes
          CONSECUTIVE=$(tac .v1-tracking/release-history.txt 2>/dev/null | awk '/PASS/{c++} /FAIL/{exit} END{print c+0}')
          echo "Consecutive clean releases: $CONSECUTIVE / 3 required"

          if [ "$CONSECUTIVE" -ge 3 ]; then
            echo "ðŸŽ‰ 3 consecutive clean releases achieved â€” v1.0 eligible!"
          fi
